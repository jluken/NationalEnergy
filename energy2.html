<!DOCTYPE html>
<html>
    <head>
        <title>D3</title>
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <script src="https://d3js.org/d3-color.v1.min.js"></script>
        <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
        <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
        <style>
            div.content {
                width : 1010px;
            }

            div.tooltip {   
                position: absolute;         
                text-align: center;         
                width: 75px;                    
                height: 75px;                               
                font: 12px sans-serif;      
                background: lightsteelblue;         
                pointer-events: none;   
            }
        </style>
    </head>
    <body>
        <div class="content">
            <svg id="prod", class="prod", width="500", height = "350", style="background: white">
            </svg>
            <svg id="cons", class="cons", width="500", height = "350", style="background: white">
            </svg>
            <svg id="total", class="total", width="1004", height = "350", style="background: white">
            </svg>
        </div>


        <script type="text/javascript">
            var prodSvg = d3.select("#prod");
            var consSvg = d3.select("#cons");
            var totalSvg = d3.select("#total");

            var prodData;

            d3.queue()
                .defer(d3.csv, "EnergyProduction.csv")
                .defer(d3.csv, "EnergyConsumption.csv")
                .await(creation);

            function creation(error, prodData, consData) {
                    console.log(prodData[0]);
                    console.log(consData[0]);
                    var barHeight = 300;
                    var barWidth = 400;
                    var year = 0;
                    var transition = d3.transition().duration(100);

                    var prodChart = prodSvg.append('g')
                        .attr('transform', 'translate( 50, 20)');
                    var yScale = d3.scaleLinear()
                        .range([barHeight, 0])
                        .domain([0,100]);
                    prodChart.append('g')
                        .call(d3.axisLeft(yScale));
                    //var sources = ['Coal','Natural Gas','Crude Oil','Plant Liquids','Nuclear','Hydro','Geothermal','Solar','Wind','Biomass'];
                    var sources = ['Coal', 'Gas', 'Oil', 'Petroleum', 'Nuclear', 'Hydro', 'Geo', 'Solar', 'Wind', 'Biomass'];
                    var xScale = d3.scaleBand()
                        .range([0, barWidth])
                        .domain(sources)
                        .padding(0.2);
                    prodChart.append('g')
                        .attr('transform', 'translate(0, 300)')
                        .call(d3.axisBottom(xScale));

                    prodSvg.append("text")
                        .attr('x',-200)
                        .attr("y", 20)
                        .attr("transform", "rotate(-90)")
                        .attr("font-family", "arial")
                        .text("% of total");

                    prodSvg.append("text")
                        .attr('id', 'prodTitle')
                        .attr('x', 130)
                        .attr("y", 50)
                        .attr("font-family", "arial")
                        .text("Energy Production by Source (1949)");

                    prodSvg.append("text")
                        .attr('id', 'prodTotal')
                        .attr('x', 165)
                        .attr("y", 75)
                        .attr("font-family", "arial")
                        .text("Total: " + prodData[0]['Total Energy'] + " Trillion BTU");
                    

                    function updateProd () {
                    //copy for updating values
                        prodChart.selectAll('rect').remove(); //use to get rid of old values
                        var prodYear = prodData[year];
                        var colors = d3.scaleOrdinal(d3.schemeRdYlGn[10]);
                        var prodBars = [prodYear['Coal'], prodYear['Natural Gas'], prodYear['Crude Oil'], 
                        prodYear['Plant Liquids'], prodYear['Nuclear'], prodYear['Hydroelectric'], prodYear['Geothermal'], 
                        prodYear['Solar'], prodYear['Wind'], prodYear['Biomass']]
                        for(var i = 0; i < prodBars.length; i++){
                            prodBars[i]= prodBars[i] * barHeight / prodYear['Total Energy'];
                        }
                        prodChart.selectAll()
                            .data(prodBars).enter()
                            .append('rect')
                            .style('fill', colors)
                            //.transition(transition)
                            .attr("transform", function (d, i) {
                                var translate = [barWidth/prodBars.length * i, 0];
                                return "translate("+ translate +")";
                            })
                            .attr('width', barWidth/prodBars.length)
                            .attr('y', function(d){ return barHeight - d})
                            .attr('height', function(d) { return d});

                        var title = "Energy Production by Source (" + (1949 + year) + ")";
                        d3.select("#prodTitle").text(title);
                        var total = "Total: " + prodYear['Total Energy'] + " Trillion BTU"
                        d3.select("#prodTotal").text(total);
                        
                    }



                    var consChart = consSvg.append('g')
                        .attr('transform', 'translate( 50, 20)');
                    consChart.append('g')
                        .call(d3.axisLeft(yScale));
                    var consumers = ['Residential', 'Commercial', 'Industrial', 'Transportation']
                    var consXScale = d3.scaleBand()
                        .range([0, 400])
                        .domain(consumers)
                        .padding(0.2);
                    consChart.append('g')
                        .attr('transform', 'translate(0, 300)')
                        .call(d3.axisBottom(consXScale));

                    consSvg.append("text")
                        .attr('x',-200)
                        .attr("y", 20)
                        .attr("transform", "rotate(-90)")
                        .attr("font-family", "arial")
                        .text("% of total");

                    consSvg.append("text")
                        .attr('id', 'consTitle')
                        .attr('x', 130)
                        .attr("y", 50)
                        .attr("font-family", "arial")
                        .text("Energy Consumption by Source (1949)");

                    consSvg.append("text")
                        .attr('id', 'consTotal')
                        .attr('x', 165)
                        .attr("y", 75)
                        .attr("font-family", "arial")
                        .text("Total: " + consData[0]['Total Energy'] + " Trillion BTU");

                    function updateCons () {
                        consChart.selectAll('rect').remove();
                        var consYear = consData[year];
                        var consColors = d3.scaleOrdinal(d3.schemeBrBG[4]);
                        var consBars = [consYear['Residential'], consYear['Commercial'],
                        consYear['Industrial'], consYear['Transportation']]
                        for(var i = 0; i < consBars.length; i++){
                            consBars[i]= consBars[i] * barHeight / consYear['Total Energy'];
                        }
                        consChart.selectAll()
                            .data(consBars).enter()
                            .append('rect')
                            .style('fill', consColors)
                            //.transition(transition)
                            .attr("transform", function (d, i) {
                                var translate = [barWidth/consBars.length * i, 0];
                                return "translate("+ translate +")";
                            })
                            .attr('width', barWidth/consBars.length)
                            .attr('y', function(d){ return barHeight - d})
                            .attr('height', function(d) { return d});

                        var title = "Energy Consumption by Source (" + (1949 + year) + ")";
                        d3.select("#consTitle").text(title);
                        var total = "Total: " + consYear['Total Energy'] + " Trillion BTU"
                        d3.select("#consTotal").text(total);
                    }
                    function update() {
                        updateProd();
                        updateCons();
                    }

                    update();

                    var prodCons = totalSvg.append('g')
                        .attr('transform', 'translate( 70, 20)');
                    var totalYScale = d3.scaleLinear()
                        .range([barHeight, 0])
                        .domain([0,100000]);
                    prodCons.append('g')
                        .call(d3.axisLeft(totalYScale));
                    var years = new Array(68);
                    for(var year = 0; year < 69; year++){
                        years[year] = year + 1949;
                    }
                    var totalXScale = d3.scaleBand()
                        .range([0, 900])
                        .domain(years)
                        .padding(0.2);
                    prodCons.append('g')
                        .attr('transform', 'translate(0, 300)')
                        .call(d3.axisBottom(totalXScale)
                            .tickValues([1950, 1955, 1960, 1965, 1970, 1975, 1980, 1985, 1990, 1995, 2000, 2005, 2010, 2015]));

                    var x = d3.scaleTime().range([0, 900]);
                    var y = d3.scaleLinear().range([barHeight, 0]);
                   

                    var line = d3.line()
                        .x(function(d) { return x(d['Year'])})
                        .y(function(d) { return y(d['Total Energy'])});

                    x.domain(d3.extent(prodData, function(d) { return d['Year']; }));
                    y.domain([0, 100000]);

                        

                    prodCons.append("path")
                        .data([prodData])
                        .attr("stroke", "blue")
                        .attr("fill", "none")
                        .attr("stroke-width", 2)
                        .attr("d", line);

                    prodCons.append("path")
                        .data([consData])
                        .attr("stroke", "red")
                        .attr("fill", "none")
                        .attr("stroke-width", 2)
                        .attr("d", line);

                    totalSvg.append("text")
                        .attr("x", 510)
                        .attr("y", 347)
                        .attr("font-family", "arial")
                        .text("year");

                    totalSvg.append("text")
                        .attr('x',-200)
                        .attr("y", 20)
                        .attr("transform", "rotate(-90)")
                        .attr("font-family", "arial")
                        .text("BTU (trillions)");

                    totalSvg.append("text")
                        .attr("x", 800)
                        .attr("y", 230)
                        .attr("font-family", "arial")
                        .attr("font-size", 14)
                        .text("US Energy Production");

                    totalSvg.append("rect")
                        .attr("x", 780)
                        .attr("y", 218)
                        .attr("width", 14)
                        .attr("height", 14)
                        .attr("fill", "blue");

                    totalSvg.append("text")
                        .attr("x", 800)
                        .attr("y", 260)
                        .attr("font-family", "arial")
                        .attr("font-size", 14)
                        .text("US Energy Consumption");

                    totalSvg.append("rect")
                        .attr("x", 780)
                        .attr("y", 248)
                        .attr("width", 14)
                        .attr("height", 14)
                        .attr("fill", "red");
                    

                    var div = d3.select("body").append("div")
                        .attr("class", "tooltip")
                        .style("opacity",0);



                    function updateUpper() {
                        var mouse = d3.mouse(this);
                        console.log(mouse);
                        var mouseX = ((mouse[0]-50)/900.0 * 68);   
                        year = Math.min(Math.round(mouseX), 68);
                        
                        update();
                        totalSvg.selectAll("rect").remove();
                        var rectangle = totalSvg.append("rect")
                            .attr("x", (Math.floor(900/68))*year + 50)
                            .attr("y", 20)
                            .attr("width", (900/68))
                            .attr("height", 300)
                            .style("opacity", .5)
                            .style("fill", "#e6e7e8");

                    }

                    function updateHover() {
                        var mouse = d3.mouse(this);
                        var mouseX = ((mouse[0]-50)/900.0 * 68);
                        year = Math.min(Math.round(mouseX), 68);
                        div.html((year+1947) + "\n" + "Production: " + prodData[year]['Total Energy'] + "\n" + "Consumption: " + consData[year]['Total Energy'])
                            .style("left", (mouse[0] + 10) + "px")
                            .style("top", (mouse[1] + 325) + "px");
                    }

                    function clearHover() {
                        div.transition()
                            .duration(100)
                            .style("opacity", 0);
                    }

                    function showHover() {
                        div.transition()
                            .duration(100)
                            .style("opacity", .9);
                    }
                    totalSvg.on('click', updateUpper);
                    totalSvg.on('mousemove', updateHover);
                    totalSvg.on('mouseout', clearHover)
                    totalSvg.on('mouseover', showHover);
                };

            

            

            
           
        </script>
    </body>
</html>